rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // DCA Bots Collection
    match /dcaBots/{botId} {
      // Allow read if authenticated
      allow read: if isAuthenticated();

      // Allow create if authenticated
      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.keys().hasAll([
          'symbol', 'initialOrderAmount', 'tradeMultiplier',
          'reEntryCount', 'stepPercent', 'stepMultiplier',
          'tpTarget', 'supportResistanceEnabled', 'reEntryDelay',
          'trendAlignmentEnabled', 'status', 'createdAt', 'updatedAt'
        ]);

      // Allow update if owner and not changing critical fields
      allow update: if isAuthenticated()
        && resource.data.userId == request.auth.uid
        && request.resource.data.userId == resource.data.userId
        && request.resource.data.createdAt == resource.data.createdAt;

      // Allow delete if owner
      allow delete: if isAuthenticated()
        && resource.data.userId == request.auth.uid;

      // Bot entries subcollection
      match /entries/{entryId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
    }

    // Bot Executions Log
    match /botExecutions/{executionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if false;
      allow delete: if false;
    }

    // Market Data (read-only for users, writable by functions)
    match /marketData/{symbol} {
      allow read: if true; // Public read
      allow write: if false; // Only functions can write
    }

    // User Settings
    match /userSettings/{userId} {
      allow read, write: if isOwner(userId);
    }

    // API Keys (encrypted)
    match /apiKeys/{userId} {
      allow read, write: if isOwner(userId);
    }

    // Audit Log
    match /auditLog/{logId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    // System Configuration (admin only)
    match /systemConfig/{configId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only admin SDK can write
    }

    // Pending Orders Queue
    match /pendingOrders/{orderId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only Cloud Functions can write via Admin SDK
    }

    // Users collection (for storing Kraken API keys)
    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }

    // System Logs
    match /systemLogs/{logId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only Cloud Functions can write
    }
  }
}
